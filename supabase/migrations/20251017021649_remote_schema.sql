revoke delete on table "public"."audit_logs" from "anon";

revoke insert on table "public"."audit_logs" from "anon";

revoke references on table "public"."audit_logs" from "anon";

revoke select on table "public"."audit_logs" from "anon";

revoke trigger on table "public"."audit_logs" from "anon";

revoke truncate on table "public"."audit_logs" from "anon";

revoke update on table "public"."audit_logs" from "anon";

revoke delete on table "public"."audit_logs" from "authenticated";

revoke insert on table "public"."audit_logs" from "authenticated";

revoke references on table "public"."audit_logs" from "authenticated";

revoke select on table "public"."audit_logs" from "authenticated";

revoke trigger on table "public"."audit_logs" from "authenticated";

revoke truncate on table "public"."audit_logs" from "authenticated";

revoke update on table "public"."audit_logs" from "authenticated";

revoke delete on table "public"."audit_logs" from "service_role";

revoke insert on table "public"."audit_logs" from "service_role";

revoke references on table "public"."audit_logs" from "service_role";

revoke select on table "public"."audit_logs" from "service_role";

revoke trigger on table "public"."audit_logs" from "service_role";

revoke truncate on table "public"."audit_logs" from "service_role";

revoke update on table "public"."audit_logs" from "service_role";

revoke delete on table "public"."chronic_requests" from "anon";

revoke insert on table "public"."chronic_requests" from "anon";

revoke references on table "public"."chronic_requests" from "anon";

revoke select on table "public"."chronic_requests" from "anon";

revoke trigger on table "public"."chronic_requests" from "anon";

revoke truncate on table "public"."chronic_requests" from "anon";

revoke update on table "public"."chronic_requests" from "anon";

revoke delete on table "public"."chronic_requests" from "authenticated";

revoke insert on table "public"."chronic_requests" from "authenticated";

revoke references on table "public"."chronic_requests" from "authenticated";

revoke select on table "public"."chronic_requests" from "authenticated";

revoke trigger on table "public"."chronic_requests" from "authenticated";

revoke truncate on table "public"."chronic_requests" from "authenticated";

revoke update on table "public"."chronic_requests" from "authenticated";

revoke delete on table "public"."chronic_requests" from "service_role";

revoke insert on table "public"."chronic_requests" from "service_role";

revoke references on table "public"."chronic_requests" from "service_role";

revoke select on table "public"."chronic_requests" from "service_role";

revoke trigger on table "public"."chronic_requests" from "service_role";

revoke truncate on table "public"."chronic_requests" from "service_role";

revoke update on table "public"."chronic_requests" from "service_role";

revoke delete on table "public"."claim_attachments" from "anon";

revoke insert on table "public"."claim_attachments" from "anon";

revoke references on table "public"."claim_attachments" from "anon";

revoke select on table "public"."claim_attachments" from "anon";

revoke trigger on table "public"."claim_attachments" from "anon";

revoke truncate on table "public"."claim_attachments" from "anon";

revoke update on table "public"."claim_attachments" from "anon";

revoke delete on table "public"."claim_attachments" from "authenticated";

revoke insert on table "public"."claim_attachments" from "authenticated";

revoke references on table "public"."claim_attachments" from "authenticated";

revoke select on table "public"."claim_attachments" from "authenticated";

revoke trigger on table "public"."claim_attachments" from "authenticated";

revoke truncate on table "public"."claim_attachments" from "authenticated";

revoke update on table "public"."claim_attachments" from "authenticated";

revoke delete on table "public"."claim_attachments" from "service_role";

revoke insert on table "public"."claim_attachments" from "service_role";

revoke references on table "public"."claim_attachments" from "service_role";

revoke select on table "public"."claim_attachments" from "service_role";

revoke trigger on table "public"."claim_attachments" from "service_role";

revoke truncate on table "public"."claim_attachments" from "service_role";

revoke update on table "public"."claim_attachments" from "service_role";

revoke delete on table "public"."claim_items" from "anon";

revoke insert on table "public"."claim_items" from "anon";

revoke references on table "public"."claim_items" from "anon";

revoke select on table "public"."claim_items" from "anon";

revoke trigger on table "public"."claim_items" from "anon";

revoke truncate on table "public"."claim_items" from "anon";

revoke update on table "public"."claim_items" from "anon";

revoke delete on table "public"."claim_items" from "authenticated";

revoke insert on table "public"."claim_items" from "authenticated";

revoke references on table "public"."claim_items" from "authenticated";

revoke select on table "public"."claim_items" from "authenticated";

revoke trigger on table "public"."claim_items" from "authenticated";

revoke truncate on table "public"."claim_items" from "authenticated";

revoke update on table "public"."claim_items" from "authenticated";

revoke delete on table "public"."claim_items" from "service_role";

revoke insert on table "public"."claim_items" from "service_role";

revoke references on table "public"."claim_items" from "service_role";

revoke select on table "public"."claim_items" from "service_role";

revoke trigger on table "public"."claim_items" from "service_role";

revoke truncate on table "public"."claim_items" from "service_role";

revoke update on table "public"."claim_items" from "service_role";

revoke delete on table "public"."claim_reviews" from "anon";

revoke insert on table "public"."claim_reviews" from "anon";

revoke references on table "public"."claim_reviews" from "anon";

revoke select on table "public"."claim_reviews" from "anon";

revoke trigger on table "public"."claim_reviews" from "anon";

revoke truncate on table "public"."claim_reviews" from "anon";

revoke update on table "public"."claim_reviews" from "anon";

revoke delete on table "public"."claim_reviews" from "authenticated";

revoke insert on table "public"."claim_reviews" from "authenticated";

revoke references on table "public"."claim_reviews" from "authenticated";

revoke select on table "public"."claim_reviews" from "authenticated";

revoke trigger on table "public"."claim_reviews" from "authenticated";

revoke truncate on table "public"."claim_reviews" from "authenticated";

revoke update on table "public"."claim_reviews" from "authenticated";

revoke delete on table "public"."claim_reviews" from "service_role";

revoke insert on table "public"."claim_reviews" from "service_role";

revoke references on table "public"."claim_reviews" from "service_role";

revoke select on table "public"."claim_reviews" from "service_role";

revoke trigger on table "public"."claim_reviews" from "service_role";

revoke truncate on table "public"."claim_reviews" from "service_role";

revoke update on table "public"."claim_reviews" from "service_role";

revoke delete on table "public"."claims" from "anon";

revoke insert on table "public"."claims" from "anon";

revoke references on table "public"."claims" from "anon";

revoke select on table "public"."claims" from "anon";

revoke trigger on table "public"."claims" from "anon";

revoke truncate on table "public"."claims" from "anon";

revoke update on table "public"."claims" from "anon";

revoke delete on table "public"."claims" from "authenticated";

revoke insert on table "public"."claims" from "authenticated";

revoke references on table "public"."claims" from "authenticated";

revoke select on table "public"."claims" from "authenticated";

revoke trigger on table "public"."claims" from "authenticated";

revoke truncate on table "public"."claims" from "authenticated";

revoke update on table "public"."claims" from "authenticated";

revoke delete on table "public"."claims" from "service_role";

revoke insert on table "public"."claims" from "service_role";

revoke references on table "public"."claims" from "service_role";

revoke select on table "public"."claims" from "service_role";

revoke trigger on table "public"."claims" from "service_role";

revoke truncate on table "public"."claims" from "service_role";

revoke update on table "public"."claims" from "service_role";

revoke delete on table "public"."members" from "anon";

revoke insert on table "public"."members" from "anon";

revoke references on table "public"."members" from "anon";

revoke select on table "public"."members" from "anon";

revoke trigger on table "public"."members" from "anon";

revoke truncate on table "public"."members" from "anon";

revoke update on table "public"."members" from "anon";

revoke delete on table "public"."members" from "authenticated";

revoke insert on table "public"."members" from "authenticated";

revoke references on table "public"."members" from "authenticated";

revoke select on table "public"."members" from "authenticated";

revoke trigger on table "public"."members" from "authenticated";

revoke truncate on table "public"."members" from "authenticated";

revoke update on table "public"."members" from "authenticated";

revoke delete on table "public"."members" from "service_role";

revoke insert on table "public"."members" from "service_role";

revoke references on table "public"."members" from "service_role";

revoke select on table "public"."members" from "service_role";

revoke trigger on table "public"."members" from "service_role";

revoke truncate on table "public"."members" from "service_role";

revoke update on table "public"."members" from "service_role";

revoke delete on table "public"."membership_types" from "anon";

revoke insert on table "public"."membership_types" from "anon";

revoke references on table "public"."membership_types" from "anon";

revoke select on table "public"."membership_types" from "anon";

revoke trigger on table "public"."membership_types" from "anon";

revoke truncate on table "public"."membership_types" from "anon";

revoke update on table "public"."membership_types" from "anon";

revoke delete on table "public"."membership_types" from "authenticated";

revoke insert on table "public"."membership_types" from "authenticated";

revoke references on table "public"."membership_types" from "authenticated";

revoke select on table "public"."membership_types" from "authenticated";

revoke trigger on table "public"."membership_types" from "authenticated";

revoke truncate on table "public"."membership_types" from "authenticated";

revoke update on table "public"."membership_types" from "authenticated";

revoke delete on table "public"."membership_types" from "service_role";

revoke insert on table "public"."membership_types" from "service_role";

revoke references on table "public"."membership_types" from "service_role";

revoke select on table "public"."membership_types" from "service_role";

revoke trigger on table "public"."membership_types" from "service_role";

revoke truncate on table "public"."membership_types" from "service_role";

revoke update on table "public"."membership_types" from "service_role";

revoke delete on table "public"."notifications" from "anon";

revoke insert on table "public"."notifications" from "anon";

revoke references on table "public"."notifications" from "anon";

revoke select on table "public"."notifications" from "anon";

revoke trigger on table "public"."notifications" from "anon";

revoke truncate on table "public"."notifications" from "anon";

revoke update on table "public"."notifications" from "anon";

revoke delete on table "public"."notifications" from "authenticated";

revoke insert on table "public"."notifications" from "authenticated";

revoke references on table "public"."notifications" from "authenticated";

revoke select on table "public"."notifications" from "authenticated";

revoke trigger on table "public"."notifications" from "authenticated";

revoke truncate on table "public"."notifications" from "authenticated";

revoke update on table "public"."notifications" from "authenticated";

revoke delete on table "public"."notifications" from "service_role";

revoke insert on table "public"."notifications" from "service_role";

revoke references on table "public"."notifications" from "service_role";

revoke select on table "public"."notifications" from "service_role";

revoke trigger on table "public"."notifications" from "service_role";

revoke truncate on table "public"."notifications" from "service_role";

revoke update on table "public"."notifications" from "service_role";

revoke delete on table "public"."reimbursement_scales" from "anon";

revoke insert on table "public"."reimbursement_scales" from "anon";

revoke references on table "public"."reimbursement_scales" from "anon";

revoke select on table "public"."reimbursement_scales" from "anon";

revoke trigger on table "public"."reimbursement_scales" from "anon";

revoke truncate on table "public"."reimbursement_scales" from "anon";

revoke update on table "public"."reimbursement_scales" from "anon";

revoke delete on table "public"."reimbursement_scales" from "authenticated";

revoke insert on table "public"."reimbursement_scales" from "authenticated";

revoke references on table "public"."reimbursement_scales" from "authenticated";

revoke select on table "public"."reimbursement_scales" from "authenticated";

revoke trigger on table "public"."reimbursement_scales" from "authenticated";

revoke truncate on table "public"."reimbursement_scales" from "authenticated";

revoke update on table "public"."reimbursement_scales" from "authenticated";

revoke delete on table "public"."reimbursement_scales" from "service_role";

revoke insert on table "public"."reimbursement_scales" from "service_role";

revoke references on table "public"."reimbursement_scales" from "service_role";

revoke select on table "public"."reimbursement_scales" from "service_role";

revoke trigger on table "public"."reimbursement_scales" from "service_role";

revoke truncate on table "public"."reimbursement_scales" from "service_role";

revoke update on table "public"."reimbursement_scales" from "service_role";

revoke delete on table "public"."roles" from "anon";

revoke insert on table "public"."roles" from "anon";

revoke references on table "public"."roles" from "anon";

revoke select on table "public"."roles" from "anon";

revoke trigger on table "public"."roles" from "anon";

revoke truncate on table "public"."roles" from "anon";

revoke update on table "public"."roles" from "anon";

revoke delete on table "public"."roles" from "authenticated";

revoke insert on table "public"."roles" from "authenticated";

revoke references on table "public"."roles" from "authenticated";

revoke select on table "public"."roles" from "authenticated";

revoke trigger on table "public"."roles" from "authenticated";

revoke truncate on table "public"."roles" from "authenticated";

revoke update on table "public"."roles" from "authenticated";

revoke delete on table "public"."roles" from "service_role";

revoke insert on table "public"."roles" from "service_role";

revoke references on table "public"."roles" from "service_role";

revoke select on table "public"."roles" from "service_role";

revoke trigger on table "public"."roles" from "service_role";

revoke truncate on table "public"."roles" from "service_role";

revoke update on table "public"."roles" from "service_role";

revoke delete on table "public"."settings" from "anon";

revoke insert on table "public"."settings" from "anon";

revoke references on table "public"."settings" from "anon";

revoke select on table "public"."settings" from "anon";

revoke trigger on table "public"."settings" from "anon";

revoke truncate on table "public"."settings" from "anon";

revoke update on table "public"."settings" from "anon";

revoke delete on table "public"."settings" from "authenticated";

revoke insert on table "public"."settings" from "authenticated";

revoke references on table "public"."settings" from "authenticated";

revoke select on table "public"."settings" from "authenticated";

revoke trigger on table "public"."settings" from "authenticated";

revoke truncate on table "public"."settings" from "authenticated";

revoke update on table "public"."settings" from "authenticated";

revoke delete on table "public"."settings" from "service_role";

revoke insert on table "public"."settings" from "service_role";

revoke references on table "public"."settings" from "service_role";

revoke select on table "public"."settings" from "service_role";

revoke trigger on table "public"."settings" from "service_role";

revoke truncate on table "public"."settings" from "service_role";

revoke update on table "public"."settings" from "service_role";

revoke delete on table "public"."users" from "anon";

revoke insert on table "public"."users" from "anon";

revoke references on table "public"."users" from "anon";

revoke select on table "public"."users" from "anon";

revoke trigger on table "public"."users" from "anon";

revoke truncate on table "public"."users" from "anon";

revoke update on table "public"."users" from "anon";

revoke delete on table "public"."users" from "authenticated";

revoke insert on table "public"."users" from "authenticated";

revoke references on table "public"."users" from "authenticated";

revoke select on table "public"."users" from "authenticated";

revoke trigger on table "public"."users" from "authenticated";

revoke truncate on table "public"."users" from "authenticated";

revoke update on table "public"."users" from "authenticated";

revoke delete on table "public"."users" from "service_role";

revoke insert on table "public"."users" from "service_role";

revoke references on table "public"."users" from "service_role";

revoke select on table "public"."users" from "service_role";

revoke trigger on table "public"."users" from "service_role";

revoke truncate on table "public"."users" from "service_role";

revoke update on table "public"."users" from "service_role";

alter table "public"."users" drop constraint "users_id_fkey";

alter table "public"."members" drop constraint "members_user_id_fkey";

alter table "public"."users" alter column "id" set default gen_random_uuid();

alter table "public"."members" add constraint "members_user_id_fkey" FOREIGN KEY (user_id) REFERENCES users(id) not valid;

alter table "public"."members" validate constraint "members_user_id_fkey";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.apply_discretionary_override(p_claim uuid, p_amount numeric, p_actor uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
begin
  if p_amount > 150000 then
    raise exception 'Discretionary override cannot exceed Ksh 150,000 as per Byelaws ยง6.1.';
  end if;

  update claims
  set override_amount = p_amount,
      total_payable = p_amount
  where id = p_claim;

  insert into claim_reviews (claim_id, reviewer_id, role, action, note)
  values (p_claim, p_actor, 'committee', 'override', 'Discretionary override applied');
end;
$function$
;

CREATE OR REPLACE FUNCTION public.compute_claim_payable(p_claim_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  c record;
  scale record;
  fund_share_amount numeric := 0;
  member_share_amount numeric := 0;
  ceiling numeric := 0;
  membership_lim numeric := null;
  membership_type_id int;
  nhif_amount numeric := 0;
  other_ins_amount numeric := 0;
  clinic_outpatient_percent numeric := null;
  yearly_spent numeric := 0;
begin
  select * into c from claims where id = p_claim_id;
  if not found then return; end if;

  if c.excluded then
    update claims
      set total_payable = 0,
          member_payable = c.total_claimed
    where id = p_claim_id;
    return;
  end if;

  select membership_type_id into membership_type_id
  from members where id = c.member_id;

  if membership_type_id is not null then
    select annual_limit into membership_lim
    from membership_types where id = membership_type_id;
  end if;

  select (value->>'clinic_outpatient_percent')::numeric
  into clinic_outpatient_percent
  from settings where key = 'general_limits';

  select * into scale
  from reimbursement_scales
  where lower(category) = lower(c.claim_type)
  limit 1;

  if not found then
    -- fallback to a minimal object structure: set local temp values
    scale := (select row(null::uuid, (value->>'fund_share_percent')::numeric, null::numeric, null::numeric) from settings where key='general_limits');
    -- note: scale.fund_share will be available via field position
  end if;

  -- compute fund/member shares
  if lower(c.claim_type) = 'outpatient'
     and clinic_outpatient_percent = 100
     and lower(coalesce(c.notes, '')) like '%siri guru nanak clinic%' then
    fund_share_amount := c.total_claimed;
    member_share_amount := 0;
  else
    fund_share_amount := (c.total_claimed * (coalesce((scale).fund_share, 80) / 100.0));
    member_share_amount := c.total_claimed - fund_share_amount;
  end if;

  ceiling := coalesce((scale).ceiling, (select (value->>'annual_limit')::numeric from settings where key='general_limits'));

  if c.nhif_number is not null and length(trim(c.nhif_number)) > 0 then
    if c.other_insurance is not null and c.other_insurance ? 'nhif' then
      nhif_amount := (c.other_insurance->>'nhif')::numeric;
    else
      nhif_amount := 0;
    end if;
  end if;

  if c.other_insurance is not null and c.other_insurance ? 'other' then
    other_ins_amount := (c.other_insurance->>'other')::numeric;
  end if;

  fund_share_amount := greatest(0, fund_share_amount - coalesce(nhif_amount,0) - coalesce(other_ins_amount,0));
  member_share_amount := c.total_claimed - fund_share_amount - coalesce(nhif_amount,0) - coalesce(other_ins_amount,0);

  if fund_share_amount > ceiling then
    fund_share_amount := ceiling;
    member_share_amount := c.total_claimed - fund_share_amount - coalesce(nhif_amount,0) - coalesce(other_ins_amount,0);
  end if;

  if membership_lim is not null and membership_lim > 0 then
    select coalesce(sum(total_payable),0) into yearly_spent
    from claims
    where member_id = c.member_id
      and date_part('year', created_at) = date_part('year', now());

    if yearly_spent + fund_share_amount > membership_lim then
      fund_share_amount := greatest(0, membership_lim - yearly_spent);
      member_share_amount := c.total_claimed - fund_share_amount - coalesce(nhif_amount,0) - coalesce(other_ins_amount,0);
    end if;
  end if;

  update claims
  set total_payable = fund_share_amount,
      member_payable = member_share_amount
  where id = p_claim_id;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.fn_autoflag_exclusions()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  c text := lower(coalesce(new.claim_type, ''));
  notes text := lower(coalesce(new.notes, ''));
  excluded_flag boolean := false;
  ci_count int := 0;
  ref_claim_id uuid;
begin
  -- Determine claim id for lookup
  if tg_op = 'INSERT' then
    ref_claim_id := new.id;
  elsif tg_op = 'UPDATE' then
    ref_claim_id := coalesce(new.id, old.id);
  else
    ref_claim_id := null;
  end if;

  if notes like '%cosmetic%' or notes like '%infertility%' or notes like '%nature cure%' then
    excluded_flag := true;
  end if;

  if ref_claim_id is not null then
    select count(*) into ci_count
    from claim_items ci
    where ci.claim_id = ref_claim_id
      and lower(ci.category) in ('cosmetic','transport','mortuary','infertility');

    if ci_count > 0 then
      excluded_flag := true;
    end if;
  end if;

  if excluded_flag then
    new.excluded := true;
  end if;

  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.fn_check_membership_active()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  m record;
  membership_start date;
begin
  select * into m from members where id = new.member_id;
  if not found then
    raise exception 'Member record not found for claim.';
  end if;

  -- benefits start after 60 days from valid_from (Constitution)
  membership_start := coalesce(m.valid_from, current_date);

  if (current_date - membership_start) < 60 then
    raise exception 'Membership waiting period (60 days) not satisfied. See Constitution ยง6.3.';
  end if;

  if m.valid_to is not null and current_date > m.valid_to then
    raise exception 'Membership expired; renew to submit claims.';
  end if;

  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.fn_check_submission_window()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  v_first_visit date := coalesce(new.date_of_first_visit, new.first_visit_date);
  v_discharge_date date := coalesce(new.date_of_discharge, new.discharge_date);
  claim_t text := lower(coalesce(new.claim_type, 'outpatient'));
begin
  if tg_op = 'INSERT' then
    if claim_t = 'outpatient' then
      if v_first_visit is null then
        raise exception 'Outpatient claims require date_of_first_visit.';
      end if;
      if (current_date - v_first_visit) > 90 then
        raise exception 'Outpatient claims must be submitted within 90 days of first visit. See Byelaws ยง4.1.';
      end if;
    elsif claim_t = 'inpatient' then
      if v_discharge_date is null then
        raise exception 'Inpatient claims require date_of_discharge.';
      end if;
      if (current_date - v_discharge_date) > 90 then
        raise exception 'Inpatient claims must be submitted within 90 days of discharge. See Byelaws ยง4.1.';
      end if;
    elsif claim_t = 'chronic' then
      -- allowed (may require doctor validation elsewhere)
      null;
    end if;
  end if;
  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.log_audit_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
begin
  insert into audit_logs (actor_id, action, meta)
  values (
    current_setting('request.jwt.claim.sub', true)::uuid,  -- current user id if available
    TG_TABLE_NAME || ':' || TG_OP,                        -- e.g. claims:INSERT
    case 
      when TG_OP = 'DELETE' then to_jsonb(OLD)
      else to_jsonb(NEW)
    end
  );
  return null;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.notify_on_claim_event()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  msg text;
begin
  if TG_OP = 'INSERT' then
    msg := 'New claim submitted with total ' || new.total_claimed;
  elsif TG_OP = 'UPDATE' and new.status != old.status then
    msg := 'Your claim status changed to ' || new.status;
  else
    return null;
  end if;

  insert into notifications (recipient_id, title, message, link)
values (
  (select user_id from members where id = new.member_id),
  'Claim Update',
  msg,
  '/claims/' || new.id
);


  return null;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.recalc_claim_total_on_items()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  sum_total numeric;
begin
  if tg_op = 'INSERT' or tg_op = 'UPDATE' then
    select coalesce(sum(amount * quantity),0) into sum_total from claim_items where claim_id = new.claim_id;
    update claims set total_claimed = sum_total where id = new.claim_id;
    perform compute_claim_payable(new.claim_id);
  elsif tg_op = 'DELETE' then
    select coalesce(sum(amount * quantity),0) into sum_total from claim_items where claim_id = old.claim_id;
    update claims set total_claimed = sum_total where id = old.claim_id;
    perform compute_claim_payable(old.claim_id);
  end if;
  return null;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.trigger_compute_claim_payable()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
begin
  perform compute_claim_payable(coalesce(new.id, old.claim_id, new.claim_id));
  return null;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.trigger_email_on_notification()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
begin
  -- Only send for specific events
  if new.type in ('claim', 'chronic') then
    perform net.http_post(
      url := current_setting('app.settings.edge_url') || '/functions/v1/send-notification-email',
      body := json_build_object('record', new)::text,
      headers := jsonb_build_object('Authorization', 'Bearer ' || current_setting('app.settings.service_role_key'))
    );
  end if;
  return new;
end;
$function$
;



